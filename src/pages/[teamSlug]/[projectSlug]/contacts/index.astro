---
import ProjectLayout from '@/layouts/project/project-layout.astro'
import ProjectContactNav from '@/layouts/project/project-contact-nav.astro'

import { Badge } from '@/components/ui/badge'

import { ContactTable } from '@/components/contacts/contact-table'

import { getContacts, getContactTotal } from '@/db/models/contact'
import { NewContactForm } from '@/components/contacts/new-contact-form'
import { handleNumberInput } from '@/lib/utils'
import {
  DEFAULT_MAX_PAGE_SIZE,
  DEFAULT_PAGE_INDEX,
  DEFAULT_PAGE_SIZE,
  DEFAULT_PAGE_SIZES,
} from '@/types'
import { getCustomFields } from '@/db/models/custom-field'

const searchParams = Astro.url.searchParams

let pageSize = searchParams.get('pageSize') ?? `${DEFAULT_PAGE_SIZE}`
pageSize = DEFAULT_PAGE_SIZES.includes(Number.parseInt(pageSize))
  ? pageSize
  : `${DEFAULT_PAGE_SIZE}`
const limit = handleNumberInput(pageSize, { min: DEFAULT_PAGE_SIZE, max: DEFAULT_MAX_PAGE_SIZE })

const page = searchParams.get('page') ?? DEFAULT_PAGE_INDEX
const pageIndex = handleNumberInput(`${page}`, { min: 1 }) - 1
const pagination = {
  pageIndex,
  pageSize: limit,
}
const offset = pageIndex * limit

const csrfToken = Astro.locals.csrfToken!
const team = Astro.locals.team!
const project = Astro.locals.project!
const ids = {
  teamId: team.id,
  projectId: project.id,
}

const customFields = await getCustomFields({
  projectId: project.id,
  teamId: team.id,
})
const data = await getContacts({
  ...ids,
  limit,
  offset,
  columnFilters: [],
})
const total = await getContactTotal(ids)
---

<ProjectLayout>
  <div class="container space-y-6">
    <div class="flex items-center justify-between">
      <div class="inline-flex items-center space-x-2">
        <h2 class="text-2xl font-bold tracking-tight">Contacts</h2>
        <Badge className="mt-0.5">{total}</Badge>
      </div>
      <NewContactForm customFields={customFields} csrfToken={csrfToken} teamId={team.id} projectId={project.id} client:load />
    </div>
    <ProjectContactNav active="contacts">
      <ContactTable
        ids={ids}
        csrfToken={csrfToken}
        total={total}
        pagination={pagination}
        csrfToken={csrfToken}
        data={data}
        className="pt-6"
        customFields={customFields}
        client:load
      />
    </ProjectContactNav>
  </div>
</ProjectLayout>
